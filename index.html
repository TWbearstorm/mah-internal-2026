<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia Analytics Hub | Thoughtworks</title>
    <link href="https://fonts.googleapis.com/css2?family=Bitter:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --tw-wave: #003D4F;
            --tw-flamingo: #F2617A;
            --tw-mist: #EDF1F3;
            --tw-talc: #FFFFFF;
            --tw-onyx: #000000;
            --tw-turmeric: #CC850A;
            --tw-jade: #6B9E78;
            --tw-sapphire: #47A1AD;
            --tw-amethyst: #634F7D;
            --font-headline: 'Bitter', Georgia, serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            color: var(--tw-wave);
            background: var(--tw-mist);
            line-height: 1.6;
            font-size: 14px;
        }

        h1, h2, h3 {
            font-family: var(--font-headline);
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: var(--tw-wave);
            border-radius: 12px 12px 0 0;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: var(--tw-flamingo);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon svg { color: var(--tw-talc); }

        .header h1 {
            color: var(--tw-talc);
            font-size: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .last-updated {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }

        .refresh-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.7);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            border-color: rgba(255,255,255,0.6);
            color: var(--tw-talc);
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            background: var(--tw-talc);
            border-bottom: 1px solid var(--tw-mist);
            display: flex;
            padding: 0;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--tw-wave);
            opacity: 0.5;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .tab-btn:hover { opacity: 0.8; }

        .tab-btn.active {
            opacity: 1;
            border-bottom-color: var(--tw-flamingo);
        }

        .tab-btn svg { width: 16px; height: 16px; }

        /* Main content */
        .main {
            background: var(--tw-mist);
            border-radius: 0 0 12px 12px;
            padding: 24px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--tw-talc);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 61, 79, 0.08);
            border: 1px solid rgba(0, 61, 79, 0.06);
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .card-header h2 {
            font-size: 16px;
            color: var(--tw-wave);
        }

        .card-header svg {
            width: 20px;
            height: 20px;
        }

        /* Stat grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-item label {
            font-size: 12px;
            color: var(--tw-wave);
            opacity: 0.6;
            display: block;
            margin-bottom: 4px;
        }

        .stat-value {
            font-family: var(--font-headline);
            font-size: 24px;
            font-weight: 700;
            color: var(--tw-wave);
            line-height: 1.2;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 100px;
            margin-top: 4px;
        }

        .stat-badge svg { width: 12px; height: 12px; }

        .stat-badge.positive {
            background: rgba(107, 158, 120, 0.12);
            color: var(--tw-jade);
        }

        .stat-badge.negative {
            background: rgba(242, 97, 122, 0.12);
            color: var(--tw-flamingo);
        }

        .stat-badge.neutral {
            background: rgba(0, 61, 79, 0.08);
            color: var(--tw-wave);
            opacity: 0.6;
        }

        /* Chart container */
        .chart-container {
            height: 280px;
            position: relative;
        }

        /* Video grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .video-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--tw-mist);
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .video-card:hover { transform: translateY(-2px); }

        .video-thumb {
            width: 120px;
            min-width: 120px;
            height: 68px;
            border-radius: 6px;
            object-fit: cover;
            background: rgba(0,61,79,0.1);
        }

        .video-info { flex: 1; min-width: 0; }

        .video-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--tw-wave);
            line-height: 1.3;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-meta {
            font-size: 11px;
            color: var(--tw-wave);
            opacity: 0.5;
            display: flex;
            gap: 12px;
        }

        /* Data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            text-align: left;
            padding: 10px 12px;
            font-weight: 600;
            color: var(--tw-wave);
            border-bottom: 2px solid var(--tw-mist);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.6;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--tw-mist);
            color: var(--tw-wave);
        }

        .data-table tr:last-child td { border-bottom: none; }

        .data-table tr:hover td { background: rgba(237, 241, 243, 0.5); }

        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.live { background: var(--tw-jade); }
        .status-dot.manual { background: var(--tw-turmeric); }
        .status-dot.offline { background: var(--tw-flamingo); }

        /* Section title */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--tw-wave);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Placeholder state */
        .placeholder {
            text-align: center;
            padding: 48px 24px;
            color: var(--tw-wave);
            opacity: 0.4;
        }

        .placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
        }

        .placeholder p {
            font-size: 14px;
        }

        /* Two column layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--tw-mist) 25%, rgba(255,255,255,0.5) 50%, var(--tw-mist) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            height: 28px;
            width: 100px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Data source badges */
        .source-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .source-badge.api {
            background: rgba(71, 161, 173, 0.12);
            color: var(--tw-sapphire);
        }

        .source-badge.csv {
            background: rgba(204, 133, 10, 0.12);
            color: var(--tw-turmeric);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-icon">
                    <i data-lucide="bar-chart-3"></i>
                </div>
                <h1>Multimedia Analytics Hub</h1>
            </div>
            <div class="header-right">
                <span class="last-updated" id="lastUpdated">Loading...</span>
                <button class="refresh-btn" id="refreshBtn" onclick="loadData()">
                    <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
                    Refresh
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <nav class="tabs">
            <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
                <i data-lucide="layout-dashboard"></i> Overview
            </button>
            <button class="tab-btn" data-tab="youtube" onclick="switchTab('youtube')">
                <i data-lucide="youtube"></i> YouTube
            </button>
            <button class="tab-btn" data-tab="linkedin" onclick="switchTab('linkedin')">
                <i data-lucide="linkedin"></i> LinkedIn
            </button>
            <button class="tab-btn" data-tab="podcasts" onclick="switchTab('podcasts')">
                <i data-lucide="mic"></i> Podcasts
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main">

            <!-- ==================== OVERVIEW TAB ==================== -->
            <section id="tab-overview" class="tab-content active">
                <!-- YouTube Summary -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="youtube" style="color:var(--tw-flamingo)"></i>
                        <h2>YouTube Summary</h2>
                        <span class="source-badge api" id="yt-source-badge">API</span>
                    </div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <label>Total Views (28d)</label>
                            <div class="stat-value" id="ov-yt-views">--</div>
                            <span class="stat-badge neutral" id="ov-yt-views-badge">--</span>
                        </div>
                        <div class="stat-item">
                            <label>Subscribers</label>
                            <div class="stat-value" id="ov-yt-subs">--</div>
                            <span class="stat-badge neutral" id="ov-yt-subs-badge">--</span>
                        </div>
                        <div class="stat-item">
                            <label>Watch Time (hrs)</label>
                            <div class="stat-value" id="ov-yt-watch">--</div>
                            <span class="stat-badge neutral" id="ov-yt-watch-badge">--</span>
                        </div>
                        <div class="stat-item">
                            <label>Engagement Rate</label>
                            <div class="stat-value" id="ov-yt-engage">--</div>
                        </div>
                    </div>
                </div>

                <!-- LinkedIn Summary -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="linkedin" style="color:var(--tw-sapphire)"></i>
                        <h2>LinkedIn Summary</h2>
                    </div>
                    <div class="placeholder">
                        <i data-lucide="link"></i>
                        <p>LinkedIn data not yet connected.<br>CSV export integration coming soon.</p>
                    </div>
                </div>

                <!-- Podcast Summary -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="mic" style="color:var(--tw-amethyst)"></i>
                        <h2>Podcast Summary</h2>
                    </div>
                    <div class="placeholder">
                        <i data-lucide="headphones"></i>
                        <p>Podcast data not yet connected.<br>Libsyn export integration coming soon.</p>
                    </div>
                </div>

                <!-- Combined Trend Chart -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="trending-up" style="color:var(--tw-wave)"></i>
                        <h2>YouTube Views Trend (28 days)</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- ==================== YOUTUBE TAB ==================== -->
            <section id="tab-youtube" class="tab-content">
                <!-- KPI Cards -->
                <div class="stat-grid" style="margin-bottom:16px;">
                    <div class="card" style="margin-bottom:0;">
                        <label style="font-size:12px;opacity:0.6;">Total Subscribers</label>
                        <div class="stat-value" id="yt-total-subs">--</div>
                    </div>
                    <div class="card" style="margin-bottom:0;">
                        <label style="font-size:12px;opacity:0.6;">Channel Views (Lifetime)</label>
                        <div class="stat-value" id="yt-channel-views">--</div>
                    </div>
                    <div class="card" style="margin-bottom:0;">
                        <label style="font-size:12px;opacity:0.6;">Total Videos</label>
                        <div class="stat-value" id="yt-total-videos">--</div>
                    </div>
                    <div class="card" style="margin-bottom:0;">
                        <label style="font-size:12px;opacity:0.6;">Engagement Rate</label>
                        <div class="stat-value" id="yt-engage-rate">--</div>
                    </div>
                </div>

                <!-- 28-day metrics from CSV -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="calendar" style="color:var(--tw-turmeric)"></i>
                        <h2>Last 28 Days (from YouTube Studio export)</h2>
                        <span class="source-badge csv">CSV</span>
                    </div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <label>Views</label>
                            <div class="stat-value" id="yt-csv-views">--</div>
                            <span class="stat-badge neutral" id="yt-csv-views-badge">--</span>
                        </div>
                        <div class="stat-item">
                            <label>Watch Time (hrs)</label>
                            <div class="stat-value" id="yt-csv-watch">--</div>
                        </div>
                        <div class="stat-item">
                            <label>Subscribers Gained</label>
                            <div class="stat-value" id="yt-csv-subs">--</div>
                        </div>
                        <div class="stat-item">
                            <label>Impressions</label>
                            <div class="stat-value" id="yt-csv-impressions">--</div>
                            <span class="stat-badge neutral" id="yt-csv-ctr-badge">--</span>
                        </div>
                    </div>
                </div>

                <div class="two-col">
                    <!-- Views Trend Chart -->
                    <div class="card">
                        <div class="card-header">
                            <i data-lucide="line-chart" style="color:var(--tw-flamingo)"></i>
                            <h2>Daily Views</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="ytViewsChart"></canvas>
                        </div>
                    </div>

                    <!-- Impressions Chart -->
                    <div class="card">
                        <div class="card-header">
                            <i data-lucide="eye" style="color:var(--tw-sapphire)"></i>
                            <h2>Daily Impressions</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="ytImpressionsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Videos -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="play-circle" style="color:var(--tw-flamingo)"></i>
                        <h2>Top Videos</h2>
                        <span class="source-badge api">API</span>
                    </div>
                    <div class="video-grid" id="videoGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- All Videos Table -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="list" style="color:var(--tw-wave)"></i>
                        <h2>All Videos (Recent 50)</h2>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Published</th>
                                    <th>Views</th>
                                    <th>Likes</th>
                                    <th>Comments</th>
                                </tr>
                            </thead>
                            <tbody id="videoTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Sources -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="database" style="color:var(--tw-wave)"></i>
                        <h2>Data Sources</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="dataSourcesTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ==================== LINKEDIN TAB ==================== -->
            <section id="tab-linkedin" class="tab-content">
                <div class="card">
                    <div class="placeholder">
                        <i data-lucide="linkedin"></i>
                        <p>LinkedIn analytics integration coming soon.<br>This tab will show company page metrics from CSV exports.</p>
                    </div>
                </div>
            </section>

            <!-- ==================== PODCASTS TAB ==================== -->
            <section id="tab-podcasts" class="tab-content">
                <div class="card">
                    <div class="placeholder">
                        <i data-lucide="mic"></i>
                        <p>Podcast analytics integration coming soon.<br>This tab will show Libsyn metrics across all podcast properties.</p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_URL = 'https://script.google.com/a/macros/thoughtworks.com/s/AKfycbzp9KZ5WlLHHsfBgA9wQ8Quemw1J7BurCmL54Zu39SHrRrJ4Mj_-gZ4OaEcQDUicaYr/exec';

        // Store data globally
        let dashData = null;
        let charts = {};

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.toggle('active', section.id === 'tab-' + tabName);
            });
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
            document.getElementById('lastUpdated').textContent = 'Loading...';

            try {
                const response = await fetch(API_URL);
                dashData = await response.json();
                console.log('Data loaded:', dashData);
                renderAll();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            } finally {
                btn.classList.remove('loading');
            }
        }

        // ============================================
        // RENDER ALL SECTIONS
        // ============================================
        function renderAll() {
            if (!dashData) return;

            renderOverview();
            renderYouTube();
            renderCharts();
            renderDataSources();
            updateLastUpdated();

            // Re-init Lucide icons for dynamically added elements
            lucide.createIcons();
        }

        // ============================================
        // HELPERS
        // ============================================
        function fmt(n) {
            if (n === null || n === undefined || n === '' || isNaN(n)) return '--';
            const num = Number(n);
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function fmtFull(n) {
            if (n === null || n === undefined || n === '' || isNaN(n)) return '--';
            return Number(n).toLocaleString();
        }

        function setBadge(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                el.textContent = '--';
                el.className = 'stat-badge neutral';
                return;
            }
            const num = Number(value);
            const prefix = num >= 0 ? '+' : '';
            el.innerHTML = `<i data-lucide="${num >= 0 ? 'trending-up' : 'trending-down'}"></i> ${prefix}${num}%`;
            el.className = 'stat-badge ' + (num >= 0 ? 'positive' : 'negative');
        }

        function parseDate(d) {
            if (!d) return null;
            // Handle epoch timestamps from Google Sheets
            if (typeof d === 'number' && d > 1000000000) {
                return new Date(d);
            }
            return new Date(d);
        }

        function shortDate(d) {
            const date = parseDate(d);
            if (!date || isNaN(date)) return '--';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function fullDate(d) {
            const date = parseDate(d);
            if (!date || isNaN(date)) return '--';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // ============================================
        // OVERVIEW RENDERING
        // ============================================
        function renderOverview() {
            const m = dashData.metrics || {};

            // YouTube overview stats
            const views = m.csvTotalViews || m.totalVideoViews || 0;
            document.getElementById('ov-yt-views').textContent = fmt(views);
            document.getElementById('ov-yt-subs').textContent = fmt(m.totalSubscribers);
            document.getElementById('ov-yt-watch').textContent = fmt(m.watchTimeHours);
            document.getElementById('ov-yt-engage').textContent = m.engagementRate ? m.engagementRate + '%' : '--';

            setBadge('ov-yt-views-badge', m.viewsChange);
            setBadge('ov-yt-subs-badge', m.subsChange);
            setBadge('ov-yt-watch-badge', m.watchChange);

            // Update source badge
            const sourceBadge = document.getElementById('yt-source-badge');
            if (m.hasWatchTime === 1 || m.hasWatchTime === 'true') {
                sourceBadge.textContent = 'API + CSV';
                sourceBadge.className = 'source-badge csv';
            }
        }

        // ============================================
        // YOUTUBE TAB RENDERING
        // ============================================
        function renderYouTube() {
            const m = dashData.metrics || {};
            const videos = dashData.videos || [];

            // Channel stats (from API)
            document.getElementById('yt-total-subs').textContent = fmt(m.totalSubscribers);
            document.getElementById('yt-channel-views').textContent = fmt(m.totalChannelViews);
            document.getElementById('yt-total-videos').textContent = fmtFull(m.totalVideos);
            document.getElementById('yt-engage-rate').textContent = m.engagementRate ? m.engagementRate + '%' : '--';

            // CSV metrics
            document.getElementById('yt-csv-views').textContent = fmt(m.csvTotalViews);
            document.getElementById('yt-csv-watch').textContent = fmt(m.watchTimeHours);
            document.getElementById('yt-csv-subs').textContent = fmtFull(m.subscribersGained);
            document.getElementById('yt-csv-impressions').textContent = fmt(m.csvImpressions);

            setBadge('yt-csv-views-badge', m.viewsChange);

            const ctr = m.csvCTR;
            const ctrBadge = document.getElementById('yt-csv-ctr-badge');
            if (ctr && ctr > 0) {
                ctrBadge.textContent = ctr + '% CTR';
                ctrBadge.className = 'stat-badge neutral';
            }

            // Top videos grid (top 10)
            const topVideos = videos.slice(0, 10);
            const videoGrid = document.getElementById('videoGrid');
            videoGrid.innerHTML = topVideos.map(v => `
                <div class="video-card">
                    <img class="video-thumb" src="${v.thumbnail || ''}" alt="${v.title || ''}" onerror="this.style.display='none'">
                    <div class="video-info">
                        <div class="video-title">${v.title || 'Untitled'}</div>
                        <div class="video-meta">
                            <span>${fmt(v.views)} views</span>
                            <span>${fmt(v.likes)} likes</span>
                            <span>${fmt(v.comments)} comments</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Videos table (all 50)
            const videoTable = document.getElementById('videoTable');
            videoTable.innerHTML = videos.map(v => `
                <tr>
                    <td style="max-width:300px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <img src="${v.thumbnail || ''}" style="width:60px;height:34px;border-radius:4px;object-fit:cover;" onerror="this.style.display='none'">
                            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.title || 'Untitled'}</span>
                        </div>
                    </td>
                    <td>${fullDate(v.publishedAt)}</td>
                    <td>${fmtFull(v.views)}</td>
                    <td>${fmtFull(v.likes)}</td>
                    <td>${fmtFull(v.comments)}</td>
                </tr>
            `).join('');
        }

        // ============================================
        // CHARTS
        // ============================================
        function renderCharts() {
            const chartData = dashData.chart || [];

            if (chartData.length === 0) return;

            // Parse dates and sort
            const sorted = chartData
                .map(d => ({
                    ...d,
                    dateObj: parseDate(d.date)
                }))
                .filter(d => d.dateObj && !isNaN(d.dateObj))
                .sort((a, b) => a.dateObj - b.dateObj);

            const labels = sorted.map(d => shortDate(d.date));
            const views = sorted.map(d => d.views || 0);
            const impressions = sorted.map(d => d.impressions || 0);

            // Shared chart options
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#003D4F',
                        titleFont: { family: 'Inter' },
                        bodyFont: { family: 'Inter' },
                        padding: 10,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: 'rgba(0,61,79,0.4)',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        grid: { color: 'rgba(0,61,79,0.06)' },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: 'rgba(0,61,79,0.4)',
                            callback: function(v) { return v >= 1000 ? (v/1000) + 'K' : v; }
                        }
                    }
                }
            };

            // Overview chart
            if (charts.overview) charts.overview.destroy();
            charts.overview = new Chart(document.getElementById('overviewChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Views',
                        data: views,
                        borderColor: '#F2617A',
                        backgroundColor: 'rgba(242, 97, 122, 0.08)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    }]
                },
                options: baseOptions
            });

            // YouTube views chart
            if (charts.ytViews) charts.ytViews.destroy();
            charts.ytViews = new Chart(document.getElementById('ytViewsChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Views',
                        data: views,
                        backgroundColor: 'rgba(242, 97, 122, 0.7)',
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: baseOptions
            });

            // YouTube impressions chart
            if (charts.ytImpressions) charts.ytImpressions.destroy();
            charts.ytImpressions = new Chart(document.getElementById('ytImpressionsChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Impressions',
                        data: impressions,
                        backgroundColor: 'rgba(71, 161, 173, 0.7)',
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: baseOptions
            });
        }

        // ============================================
        // DATA SOURCES TABLE
        // ============================================
        function renderDataSources() {
            const m = dashData.metrics || {};
            const c = dashData.config || {};

            const apiDate = m.lastApiUpdate ? fullDate(m.lastApiUpdate) : '--';
            const csvStatus = c.youtube_csv_status || 'Not run';
            const csvDate = c.last_youtube_csv_update ? fullDate(c.last_youtube_csv_update) : '--';

            document.getElementById('dataSourcesTable').innerHTML = `
                <tr>
                    <td><span class="status-dot live"></span>YouTube Data API</td>
                    <td><span class="source-badge api">Automated</span></td>
                    <td>${apiDate}</td>
                    <td>Channel stats, video details (top ${m.videosAnalyzed || 50})</td>
                </tr>
                <tr>
                    <td><span class="status-dot manual"></span>YouTube Studio CSV</td>
                    <td><span class="source-badge csv">Manual</span></td>
                    <td>${csvDate}</td>
                    <td>${csvStatus}</td>
                </tr>
                <tr>
                    <td><span class="status-dot offline"></span>LinkedIn</td>
                    <td><span style="opacity:0.4;">Not connected</span></td>
                    <td>--</td>
                    <td>Coming soon</td>
                </tr>
                <tr>
                    <td><span class="status-dot offline"></span>Podcasts (Libsyn)</td>
                    <td><span style="opacity:0.4;">Not connected</span></td>
                    <td>--</td>
                    <td>Coming soon</td>
                </tr>
            `;
        }

        // ============================================
        // LAST UPDATED
        // ============================================
        function updateLastUpdated() {
            const m = dashData.metrics || {};
            if (m.lastApiUpdate) {
                const date = new Date(m.lastApiUpdate);
                document.getElementById('lastUpdated').textContent =
                    'Updated ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) +
                    ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                document.getElementById('lastUpdated').textContent = 'Data loaded';
            }
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadData();
        });
    </script>
</body>
</html>
